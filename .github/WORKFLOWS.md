# GitHub Actions å·¥ä½œæµè¯´æ˜

æœ¬é¡¹ç›®ä½¿ç”¨ GitHub Actions å®ç°å®Œå…¨è‡ªåŠ¨åŒ–çš„ CI/CD æµç¨‹ã€‚ä»¥ä¸‹æ˜¯å„ä¸ªå·¥ä½œæµçš„è¯¦ç»†è¯´æ˜ï¼š

## ğŸ“‹ å·¥ä½œæµæ¦‚è§ˆ

| å·¥ä½œæµ | è§¦å‘æ¡ä»¶ | ä¸»è¦åŠŸèƒ½ | çŠ¶æ€ |
|--------|----------|----------|------|
| [CI](.github/workflows/ci.yml) | Push, PR | ä»£ç è´¨é‡æ£€æŸ¥ã€æµ‹è¯• | [![CI](https://github.com/your-username/png2icns/actions/workflows/ci.yml/badge.svg)](https://github.com/your-username/png2icns/actions/workflows/ci.yml) |
| [Build and Release](.github/workflows/build-and-release.yml) | Push, Tag | æ„å»ºäºŒè¿›åˆ¶ã€åˆ›å»ºå‘å¸ƒ | [![Build and Release](https://github.com/your-username/png2icns/actions/workflows/build-and-release.yml/badge.svg)](https://github.com/your-username/png2icns/actions/workflows/build-and-release.yml) |
| [Docker Publish](.github/workflows/docker-publish.yml) | Push, Tag | æ„å»ºå’Œå‘å¸ƒ Docker é•œåƒ | [![Docker Publish](https://github.com/your-username/png2icns/actions/workflows/docker-publish.yml/badge.svg)](https://github.com/your-username/png2icns/actions/workflows/docker-publish.yml) |
| [Cleanup](.github/workflows/cleanup.yml) | å®šæ—¶ä»»åŠ¡ | æ¸…ç†æ—§çš„åˆ¶å“å’Œç¼“å­˜ | - |

## ğŸ”„ CI å·¥ä½œæµ (ci.yml)

### è§¦å‘æ¡ä»¶
- Push åˆ° `main`, `master`, `develop` åˆ†æ”¯
- Pull Request åˆ° `main`, `master` åˆ†æ”¯
- æ¯æ—¥å®šæ—¶è¿è¡Œ (UTC 2:00 AM)

### ä½œä¸šè¯¦æƒ…

#### 1. **Lint** ä½œä¸š
- **ç›®çš„**: ä»£ç è´¨é‡æ£€æŸ¥
- **æ­¥éª¤**:
  - æ£€æŸ¥ä»£ç æ ¼å¼ (`cargo fmt`)
  - è¿è¡Œ Clippy é™æ€åˆ†æ
  - æ£€æŸ¥æ–‡æ¡£ç”Ÿæˆ

#### 2. **Test** ä½œä¸š
- **ç›®çš„**: å¤šå¹³å°æµ‹è¯•
- **çŸ©é˜µç­–ç•¥**:
  - æ“ä½œç³»ç»Ÿ: Ubuntu, macOS
  - Rust ç‰ˆæœ¬: stable, beta
- **æ­¥éª¤**:
  - è¿è¡Œå•å…ƒæµ‹è¯•
  - æ„å»º release ç‰ˆæœ¬
  - æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶

#### 3. **Docker Test** ä½œä¸š
- **ç›®çš„**: Docker åŠŸèƒ½æµ‹è¯•
- **æ­¥éª¤**:
  - æ„å»º Docker é•œåƒ
  - æµ‹è¯•åŸºæœ¬åŠŸèƒ½
  - è¿è¡Œç»¼åˆæµ‹è¯•ï¼ˆå¤šç§é¢„è®¾å’Œå°ºå¯¸ï¼‰

#### 4. **Security Audit** ä½œä¸š
- **ç›®çš„**: å®‰å…¨æ£€æŸ¥
- **æ­¥éª¤**:
  - è¿è¡Œ `cargo audit`
  - æ£€æŸ¥ä¾èµ–æ¼æ´

#### 5. **Coverage** ä½œä¸š
- **ç›®çš„**: ä»£ç è¦†ç›–ç‡
- **æ­¥éª¤**:
  - ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
  - ä¸Šä¼ åˆ° Codecov

#### 6. **Benchmark** ä½œä¸š
- **ç›®çš„**: æ€§èƒ½åŸºå‡†æµ‹è¯•
- **è§¦å‘æ¡ä»¶**: ä»…åœ¨ main åˆ†æ”¯ push æ—¶è¿è¡Œ
- **æ­¥éª¤**:
  - åˆ›å»ºåŸºå‡†æµ‹è¯•å›¾åƒ
  - è¿è¡Œè½¬æ¢æ€§èƒ½æµ‹è¯•

## ğŸš€ æ„å»ºå’Œå‘å¸ƒå·¥ä½œæµ (build-and-release.yml)

### è§¦å‘æ¡ä»¶
- Push åˆ°ä¸»è¦åˆ†æ”¯
- åˆ›å»ºæ ‡ç­¾ (`v*`)
- Pull Request

### ä½œä¸šè¯¦æƒ…

#### 1. **Test** ä½œä¸š
- **ç›®çš„**: å‘å¸ƒå‰æµ‹è¯•
- **æ­¥éª¤**:
  - æ„å»º Docker é•œåƒ
  - åˆ›å»ºæµ‹è¯•å›¾åƒ
  - éªŒè¯è½¬æ¢åŠŸèƒ½

#### 2. **Build Binary** ä½œä¸š
- **ç›®çš„**: å¤šå¹³å°äºŒè¿›åˆ¶æ„å»º
- **çŸ©é˜µç­–ç•¥**:
  - Linux x86_64 (glibc)
  - Linux x86_64 (musl)
  - macOS x86_64
  - macOS ARM64
- **æ­¥éª¤**:
  - äº¤å‰ç¼–è¯‘
  - åˆ›å»ºå‹ç¼©åŒ…
  - ç”Ÿæˆæ ¡éªŒå’Œ
  - ä¸Šä¼ åˆ¶å“

#### 3. **Build Docker** ä½œä¸š
- **ç›®çš„**: å¤šæ¶æ„ Docker é•œåƒ
- **æ­¥éª¤**:
  - æ„å»º `linux/amd64` å’Œ `linux/arm64`
  - æ¨é€åˆ° GitHub Container Registry
  - ç”Ÿæˆå…ƒæ•°æ®æ ‡ç­¾

#### 4. **Release** ä½œä¸š
- **è§¦å‘æ¡ä»¶**: ä»…åœ¨åˆ›å»ºæ ‡ç­¾æ—¶è¿è¡Œ
- **æ­¥éª¤**:
  - ä¸‹è½½æ‰€æœ‰åˆ¶å“
  - åˆ›å»º GitHub Release
  - ä¸Šä¼ äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ ¡éªŒå’Œ
  - ç”Ÿæˆå‘å¸ƒè¯´æ˜

#### 5. **Security Scan** ä½œä¸š
- **ç›®çš„**: å®‰å…¨æ‰«æ
- **æ­¥éª¤**:
  - ä½¿ç”¨ Trivy æ‰«æ Docker é•œåƒ
  - ä¸Šä¼ ç»“æœåˆ° GitHub Security

## ğŸ³ Docker å‘å¸ƒå·¥ä½œæµ (docker-publish.yml)

### è§¦å‘æ¡ä»¶
- Push åˆ° `main`, `master` åˆ†æ”¯
- åˆ›å»ºæ ‡ç­¾
- æ¯å‘¨å®šæ—¶é‡å»º (å‘¨æ—¥ UTC 3:00 AM)

### ä½œä¸šè¯¦æƒ…

#### 1. **Build and Push** ä½œä¸š
- **æ­¥éª¤**:
  - å¤šæ¶æ„æ„å»º (`linux/amd64`, `linux/arm64`)
  - æ¨é€åˆ° GitHub Container Registry
  - ç”Ÿæˆ SBOM (è½¯ä»¶ç‰©æ–™æ¸…å•)
  - å®‰å…¨æ‰«æ
  - æµ‹è¯•å‘å¸ƒçš„é•œåƒ

#### 2. **Update README** ä½œä¸š
- **ç›®çš„**: è‡ªåŠ¨æ›´æ–°æ–‡æ¡£
- **æ­¥éª¤**:
  - æ›´æ–° README ä¸­çš„æ„å»ºä¿¡æ¯
  - è‡ªåŠ¨æäº¤æ›´æ”¹

## ğŸ§¹ æ¸…ç†å·¥ä½œæµ (cleanup.yml)

### è§¦å‘æ¡ä»¶
- æ¯å‘¨å®šæ—¶è¿è¡Œ (å‘¨å…­ UTC 1:00 AM)
- æ‰‹åŠ¨è§¦å‘

### ä½œä¸šè¯¦æƒ…

#### 1. **Cleanup Packages** ä½œä¸š
- **ç›®çš„**: æ¸…ç†æ—§çš„å®¹å™¨é•œåƒ
- **ç­–ç•¥**: ä¿ç•™æœ€æ–° 10 ä¸ªç‰ˆæœ¬ï¼Œåˆ é™¤æœªæ ‡è®°ç‰ˆæœ¬

#### 2. **Cleanup Artifacts** ä½œä¸š
- **ç›®çš„**: æ¸…ç†æ—§çš„æ„å»ºåˆ¶å“
- **ç­–ç•¥**: åˆ é™¤ 30 å¤©å‰çš„åˆ¶å“ï¼Œä¿ç•™æœ€è¿‘ 5 ä¸ª

#### 3. **Cleanup Caches** ä½œä¸š
- **ç›®çš„**: æ¸…ç†æ—§çš„æ„å»ºç¼“å­˜
- **ç­–ç•¥**: åˆ é™¤ 7 å¤©å‰çš„ç¼“å­˜

## ğŸ”§ é…ç½®å’Œå¯†é’¥

### å¿…éœ€çš„ GitHub Secrets
- `GITHUB_TOKEN`: è‡ªåŠ¨æä¾›ï¼Œç”¨äºè®¿é—® GitHub API

### å¯é€‰çš„ Secrets
- `CODECOV_TOKEN`: ç”¨äºä¸Šä¼ ä»£ç è¦†ç›–ç‡æŠ¥å‘Š

### æƒé™è¦æ±‚
- `contents: write`: åˆ›å»ºå‘å¸ƒå’Œæäº¤
- `packages: write`: æ¨é€ Docker é•œåƒ
- `security-events: write`: ä¸Šä¼ å®‰å…¨æ‰«æç»“æœ
- `actions: write`: ç®¡ç†åˆ¶å“å’Œç¼“å­˜

## ğŸ“Š åˆ¶å“å’Œè¾“å‡º

### æ„å»ºåˆ¶å“
- **äºŒè¿›åˆ¶æ–‡ä»¶**: å¤šå¹³å°å¯æ‰§è¡Œæ–‡ä»¶
- **Docker é•œåƒ**: å¤šæ¶æ„å®¹å™¨é•œåƒ
- **æ ¡éªŒå’Œ**: SHA256 æ ¡éªŒæ–‡ä»¶
- **SBOM**: è½¯ä»¶ç‰©æ–™æ¸…å•

### å‘å¸ƒä½ç½®
- **GitHub Releases**: äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ ¡éªŒå’Œ
- **GitHub Container Registry**: Docker é•œåƒ
- **GitHub Security**: å®‰å…¨æ‰«ææŠ¥å‘Š

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ„å»ºå¤±è´¥**
   - æ£€æŸ¥ Rust ä»£ç ç¼–è¯‘é”™è¯¯
   - éªŒè¯ä¾èµ–ç‰ˆæœ¬å…¼å®¹æ€§
   - æŸ¥çœ‹ CI æ—¥å¿—è¯¦ç»†ä¿¡æ¯

2. **Docker æ„å»ºå¤±è´¥**
   - æ£€æŸ¥ Dockerfile è¯­æ³•
   - éªŒè¯åŸºç¡€é•œåƒå¯ç”¨æ€§
   - æ£€æŸ¥å¤šæ¶æ„æ„å»ºæ”¯æŒ

3. **å‘å¸ƒå¤±è´¥**
   - ç¡®è®¤æ ‡ç­¾æ ¼å¼æ­£ç¡® (`v*`)
   - æ£€æŸ¥æƒé™è®¾ç½®
   - éªŒè¯åˆ¶å“ç”Ÿæˆ

4. **å®‰å…¨æ‰«æå¤±è´¥**
   - æ›´æ–°ä¾èµ–ç‰ˆæœ¬
   - æ£€æŸ¥å·²çŸ¥æ¼æ´
   - æŸ¥çœ‹ Trivy æŠ¥å‘Š

### è°ƒè¯•æŠ€å·§

1. **æœ¬åœ°æµ‹è¯•**
   ```bash
   # æ¨¡æ‹Ÿ CI ç¯å¢ƒ
   act -j test
   
   # æµ‹è¯• Docker æ„å»º
   docker build -t test .
   ```

2. **æŸ¥çœ‹æ—¥å¿—**
   - åœ¨ GitHub Actions é¡µé¢æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
   - ä½¿ç”¨ `set -x` å¯ç”¨ shell è°ƒè¯•
   - æ·»åŠ è°ƒè¯•è¾“å‡º

3. **æ‰‹åŠ¨è§¦å‘**
   - ä½¿ç”¨ `workflow_dispatch` æ‰‹åŠ¨è¿è¡Œ
   - æµ‹è¯•ç‰¹å®šåˆ†æ”¯æˆ–æäº¤

## ğŸ“ˆ ç›‘æ§å’ŒæŒ‡æ ‡

### å¯ç”¨æŒ‡æ ‡
- **æ„å»ºæ—¶é—´**: å„ä¸ªä½œä¸šçš„æ‰§è¡Œæ—¶é—´
- **æˆåŠŸç‡**: CI/CD æµç¨‹çš„æˆåŠŸç‡
- **åˆ¶å“å¤§å°**: äºŒè¿›åˆ¶æ–‡ä»¶å’Œé•œåƒå¤§å°
- **å®‰å…¨æ‰«æ**: æ¼æ´æ•°é‡å’Œä¸¥é‡ç¨‹åº¦

### ç›‘æ§å»ºè®®
- è®¾ç½® GitHub é€šçŸ¥
- ç›‘æ§æ„å»ºæ—¶é—´è¶‹åŠ¿
- å®šæœŸæ£€æŸ¥å®‰å…¨æŠ¥å‘Š
- è·Ÿè¸ªå‘å¸ƒé¢‘ç‡

---

è¿™ä¸ª CI/CD æµç¨‹ç¡®ä¿äº†ä»£ç è´¨é‡ã€å®‰å…¨æ€§å’Œå¯é çš„è‡ªåŠ¨åŒ–å‘å¸ƒã€‚å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹å…·ä½“çš„å·¥ä½œæµæ–‡ä»¶æˆ–åˆ›å»º Issueã€‚